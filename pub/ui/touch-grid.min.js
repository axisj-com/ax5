!function(root,ax_super){var U=ax5.util,axd=ax5.dom,ax_class=function(){this.main=function(){ax_super&&ax_super.call(this),this.config={click_event_name:"ontouchstart"in document.documentElement?"touchstart":"click",theme:"default",head_height:28,item_height:28,col_min_width:30,body:{}}}.apply(this,arguments),this.focused_index=-1,this.col_group=[],this.col_width_sum=0,this.list=[];var cfg=this.config;this.init=function(){cfg.target||U.error("aui_touch_grid_400","[ax5.ui.touch_grid] config.target is required"),cfg.target=ax5.dom(cfg.target),this.col_group=this.convert_col_group(cfg.col_group),cfg.target.append(this.get_frame()),this.els={root:cfg.target.find('[data-touch-grid-els="root"]'),main:cfg.target.find('[data-touch-grid-els="main"]'),"main-header":cfg.target.find('[data-touch-grid-els="main-header"]'),"main-body":cfg.target.find('[data-touch-grid-els="main-body"]'),"main-body-content":cfg.target.find('[data-touch-grid-els="main-body-content"]')},this.set_size_frame(),this.els["main-header"].html(this.get_header("main-header")),this.bind_window_resize(function(){this.col_group=this.convert_col_group(cfg.col_group),this.set_size_frame(),this.set_size_col_group()})},this.get_frame=function(){var po=[];return po.push('<div class="ax5-ui-touch-grid '+cfg.theme+'" data-touch-grid-els="root">'),po.push('<div class="touch-grid-main" data-touch-grid-els="main">'),po.push('<div class="touch-grid-main-header" data-touch-grid-els="main-header">'),po.push("</div>"),po.push('<div class="touch-grid-main-body" data-touch-grid-els="main-body">'),po.push('<div class="touch-grid-content" data-touch-grid-els="main-body-content"></div>'),po.push("</div>"),po.push("</div>"),po.push("</div>"),po.join("")},this.set_size_frame=function(){var target_height=cfg.target.height();this.els.main.css({height:target_height}),this.els["main-header"].css({height:cfg.head_height}),this.els["main-body"].css({height:target_height-cfg.head_height})},this.convert_col_group=function(col_group){for(var CG=[],target_width=cfg.target.width(),free_width=target_width,free_width_col_count=0,i=0,l=col_group.length;l>i;i++)CG.push(U.clone(col_group[i]));this.col_width_sum=0;for(var i=0,l=CG.length;l>i;i++)U.is_undefined(CG[i].width)||"*"===CG[i].width?free_width_col_count++:(this.col_width_sum+=U.number(CG[i].width),free_width-=U.number(CG[i].width));if(free_width_col_count>0)for(var i=0,l=CG.length;l>i;i++)(U.is_undefined(CG[i].width)||"*"===CG[i].width)&&(CG[i].width=free_width/free_width_col_count,CG[i].width<cfg.col_min_width&&(CG[i].width=cfg.col_min_width),this.col_width_sum+=U.number(CG[i].width));return CG},this.get_col_group=function(){var po=[];po.push("<colgroup>");for(var i=0,l=this.col_group.length;l>i;i++)po.push('<col data-touch-grid-col="'+i+'"  style="width:'+this.col_group[i].width+'px;" />');return po.push("</colgroup>"),po.join("")},this.set_size_col_group=function(){for(var i=0,l=this.col_group.length;l>i;i++)this.els.main.find('[data-touch-grid-col="'+i+'"]').css({width:this.col_group[i].width})},this.get_header=function(typ){var po=[];po.push('<table data-touch-grid-table="'+typ+'" style="width:'+this.col_width_sum+"px;height:"+cfg.head_height+'px;">'),po.push(this.get_col_group()),po.push("<tbody>"),po.push('<tr style="'+function(){return cfg.head_align?"text-align:"+cfg.head_align+";":""}()+'">');for(var i=0,l=this.col_group.length;l>i;i++)po.push('<td style="'+function(C){return cfg.head_align||!C.align?"":"text-align:"+C.align+";"}(this.col_group[i])+'">'+this.col_group[i].label+"</td>");return po.push("</tr>"),po.push("</tbody>"),po.push("</table>"),po.join("")},this.get_list=function(typ){var po=[];if(this.list.length>0){po.push('<table data-touch-grid-table="'+typ+'" style="width:'+this.col_width_sum+'px;">'),po.push(this.get_col_group()),po.push("<tbody>");for(var item,r=0,len=this.list.length;len>r;r++){item=this.list[r],po.push('<tr data-touch-grid-item-row="'+r+'" style="height:'+cfg.item_height+'px;">');for(var i=0,l=this.col_group.length;l>i;i++)po.push('<td style="'+function(C){return C.align?"text-align:"+C.align+";":""}(this.col_group[i])+'">'+this.get_col_value(item,this.col_group,i)+"</td>");po.push("</tr>")}po.push("</tbody>"),po.push("</table>")}return po.join("")},this.get_col_value=function(item,CG,ci){if(U.is_function(CG[ci].formatter)){var that={list:this.list,item:item,col_group:CG,key:CG[ci].key,col_index:ci,value:item[CG[ci].key]};return CG[ci].formatter.call(that)||""}return"money"===CG[ci].formatter?U.number(item[CG[ci].key]||0,{money:!0}):item[CG[ci].key]||""},this.set_list=function(list){this.list=list,this.focused_index=-1,this.els["main-body-content"].html(this.get_list("main-body")),this.els["main-body-content"].on("click",function(e){this.onclick(e||window.event)}.bind(this)),this.focus(0)},this.focus=function(index,by){if(this.focused_index>-1&&this.els["main-body-content"].find('[data-touch-grid-item-row="'+this.focused_index+'"]').class_name("remove","focus"),"last"==index)index=this.list.length-1;else if("undefined"!=typeof by){if(-1==this.focused_index)return;index=this.focused_index+index}index=U.number(index),0>index&&(index=0),index>=this.list.length&&(index=this.list.length-1);var focused_item,focused_item_height,focused_item_top,body_content_top,body_height,view_position_top;focused_item=this.els["main-body-content"].find('[data-touch-grid-item-row="'+index+'"]'),0!=focused_item.length&&(focused_item_height=focused_item.height(),focused_item_top=focused_item.position().top,body_content_top=this.els["main-body-content"].position().top,body_height=this.els["main-body"].height(),view_position_top=focused_item_top+body_content_top,focused_item.class_name("add","focus"),this.focused_index=index,view_position_top+focused_item_height>body_height?this.els["main-body-content"].css({top:body_height-(focused_item_top+focused_item_height)}):0>view_position_top&&this.els["main-body-content"].css({top:-focused_item_top}))},this.onclick=function(e,target,index,that){target=axd.parent(e.target,function(target){return axd.attr(target,"data-touch-grid-item-row")?!0:void 0}),target&&(index=axd.attr(target,"data-touch-grid-item-row"),that={list:this.list,item:this.list[index],target:cfg.target.elements[0],item_target:target},this.focus(index),cfg.body.onclick&&cfg.body.onclick.call(that))}};U.is_function(ax_super)&&(ax_class.prototype=new ax_super),root.touch_grid=ax_class,"function"==typeof define&&define.amd&&define("_ax5_ui_touch_grid",[],function(){return ax_class})}(ax5.ui,ax5.ui.root);